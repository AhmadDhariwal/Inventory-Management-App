<main class="purchase-list-container" role="main">
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 id="page-title">Purchase Orders</h1>
        <p class="subtitle">Manage and track all purchase orders</p>
      </div>
      <nav class="breadcrumb" aria-label="Breadcrumb navigation">
        <ol class="breadcrumb-list">
          <li><a href="/dashboard" aria-label="Go to dashboard">Dashboard</a></li>
          <li aria-current="page">Purchase Orders</li>
        </ol>
      </nav>
    </div>
  </div>

  <section class="content-section" aria-labelledby="page-title">
    <div class="toolbar">
      <div class="search-filters">
        <div class="search-field">
          <label for="search-input" class="sr-only">Search purchase orders</label>
          <div class="input-wrapper">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
            </svg>
            <input
              id="search-input"
              type="search"
              class="search-control"
              placeholder="Search by supplier, warehouse..."
              [(ngModel)]="searchTerm"
              (input)="onSearch()"
              aria-label="Search purchase orders">
          </div>
        </div>
        <div class="filter-controls">
          <select class="filter-select" [(ngModel)]="selectedSupplier" (change)="onFilter()" aria-label="Filter by supplier">
            <option value="">All Suppliers</option>
            <option *ngFor="let supplier of suppliers; trackBy: trackBySupplier" [value]="supplier._id">
              {{ supplier.name }}
            </option>
          </select>
        </div>
      </div>
      <div class="action-buttons">
        <div class="export-dropdown">
          <button type="button" class="btn btn-outline dropdown-toggle" (click)="toggleExportDropdown()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
            </svg>
            Export
          </button>
          <div class="dropdown-menu" [class.show]="showExportDropdown">
            <button type="button" class="dropdown-item" (click)="exportCSV()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
              </svg>
              Export as CSV
            </button>
            <button type="button" class="dropdown-item" (click)="exportExcel()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
              </svg>
              Export as Excel
            </button>
            <button type="button" class="dropdown-item" (click)="printList()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
              </svg>
              Print List
            </button>
          </div>
        </div>
        <button type="button" class="btn btn-outline" (click)="refreshList()" [attr.aria-label]="'Refresh purchase orders list'">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
            <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
          </svg>
          Refresh
        </button>
        <a routerLink="/purchases/new" class="btn btn-primary" [attr.aria-label]="'Create new purchase order'">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/>
          </svg>
          New Purchase Order
        </a>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state" role="status" aria-live="polite">
      <div class="loading-spinner">
        <svg class="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"/>
          <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
      </div>
      <p>Loading purchase orders...</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && filteredPurchaseOrders.length === 0" class="empty-state">
      <div class="empty-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" aria-hidden="true">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
        </svg>
      </div>
      <h2>No Purchase Orders Found</h2>
      <p>{{ searchTerm || selectedSupplier ? 'No purchase orders match your current filters.' : 'Get started by creating your first purchase order.' }}</p>
      <a *ngIf="!searchTerm && !selectedSupplier" routerLink="/purchases/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
          <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/>
        </svg>
        Create First Purchase Order
      </a>
    </div>

    <!-- Data Table -->
    <div *ngIf="!isLoading && filteredPurchaseOrders.length > 0" class="table-container">
      <div class="table-wrapper">
        <table class="data-table" role="table" aria-label="Purchase orders list">
          <thead>
            <tr role="row">
              <th scope="col" class="sortable" (click)="sortBy('orderNumber')" [attr.aria-sort]="getSortDirection('orderNumber')">
                <span class="th-content">
                  <span>Order #</span>
                  <svg class="sort-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true">
                    <path d="M6 3l4 4H2l4-4z"/>
                  </svg>
                </span>
              </th>
              <th scope="col" class="sortable" (click)="sortBy('supplier')" [attr.aria-sort]="getSortDirection('supplier')">
                <span class="th-content">
                  <span>Supplier</span>
                  <svg class="sort-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true">
                    <path d="M6 3l4 4H2l4-4z"/>
                  </svg>
                </span>
              </th>
              <th scope="col" class="sortable" (click)="sortBy('warehouse')" [attr.aria-sort]="getSortDirection('warehouse')">
                <span class="th-content">
                  <span>Warehouse</span>
                  <svg class="sort-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true">
                    <path d="M6 3l4 4H2l4-4z"/>
                  </svg>
                </span>
              </th>
              <th scope="col" class="sortable numeric" (click)="sortBy('totalamount')" [attr.aria-sort]="getSortDirection('totalamount')">
                <span class="th-content">
                  <span>Total Amount</span>
                  <svg class="sort-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true">
                    <path d="M6 3l4 4H2l4-4z"/>
                  </svg>
                </span>
              </th>
              <th scope="col" class="sortable" (click)="sortBy('createdBy')" [attr.aria-sort]="getSortDirection('createdBy')">
                <span class="th-content">
                  <span>Created By</span>
                  <svg class="sort-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true">
                    <path d="M6 3l4 4H2l4-4z"/>
                  </svg>
                </span>
              </th>
              <th scope="col" class="sortable" (click)="sortBy('createdAt')" [attr.aria-sort]="getSortDirection('createdAt')">
                <span class="th-content">
                  <span>Date Created</span>
                  <svg class="sort-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true">
                    <path d="M6 3l4 4H2l4-4z"/>
                  </svg>
                </span>
              </th>
              <th scope="col">Status</th>
              <th scope="col" class="actions-col">
                <span class="sr-only">Actions</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let po of filteredPurchaseOrders; let i = index; trackBy: trackByPurchaseOrder"
                role="row"
                class="table-row"
                [attr.aria-rowindex]="i + 2">
              <td class="order-number" [attr.data-label]="'Order #'">
                <span class="order-badge">PO-{{ generateOrderNumber(i) }}</span>
              </td>
              <td [attr.data-label]="'Supplier'">
                <div class="supplier-info">
                  <span class="supplier-name">{{ po.supplier.name || 'N/A' }}</span>
                </div>
              </td>
              <td [attr.data-label]="'Warehouse'">
                <span class="warehouse-name">{{ po.warehouse.name || 'N/A' }}</span>
              </td>
              <td class="numeric" [attr.data-label]="'Total Amount'">
                <span class="amount">{{ po.totalamount | currency:'USD':'symbol':'1.2-2' }}</span>
              </td>
              <td [attr.data-label]="'Created By'">
                <div class="user-info">
                  <span class="user-name">{{ po.createdBy.name || 'Unknown' }}</span>
                </div>
              </td>
              <td [attr.data-label]="'Date Created'">
                <time [attr.datetime]="po.createdAt" class="date-time">
                  {{ po.createdAt | date:'MMM d, y' }}
                </time>
              </td>
              <td [attr.data-label]="'Status'">
                <span class="status-badge" [ngClass]="getStatusClass(po.status || 'PENDING')">
                  {{ po.status || 'PENDING' }}
                </span>
              </td>
              <td class="actions-cell">
                <div class="action-menu">
                  <button type="button"
                          class="btn btn-ghost btn-sm"
                          (click)="viewPurchaseOrder(po)"
                          [attr.aria-label]="'View purchase order PO-' + generateOrderNumber(i)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                      <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                      <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                    </svg>
                    View
                  </button>
                  <button *ngIf="po.status === 'PENDING'"
                          type="button"
                          class="btn btn-ghost btn-sm btn-success"
                          (click)="approvePurchaseOrder(po)"
                          [attr.aria-label]="'Approve purchase order PO-' + generateOrderNumber(i)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                      <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                    </svg>
                    Approve
                  </button>
                  <button *ngIf="po.status === 'APPROVED'"
                          type="button"
                          class="btn btn-ghost btn-sm btn-primary"
                          (click)="receivePurchaseOrder(po)"
                          [attr.aria-label]="'Receive purchase order PO-' + generateOrderNumber(i)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                      <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                    </svg>
                    Receive
                  </button>
                  <button *ngIf="po.status === 'PENDING'"
                          type="button"
                          class="btn btn-ghost btn-sm btn-danger"
                          (click)="deletePurchaseOrder(po)"
                          [attr.aria-label]="'Delete purchase order PO-' + generateOrderNumber(i)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                      <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <nav *ngIf="!isLoading && filteredPurchaseOrders.length > 0" class="pagination-nav" aria-label="Purchase orders pagination">
      <div class="pagination-info">
        <span>Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ Math.min(currentPage * pageSize, totalItems) }} of {{ totalItems }} results</span>
      </div>
      <div class="pagination-controls">
        <button type="button"
                class="btn btn-ghost btn-sm"
                [disabled]="currentPage === 1"
                (click)="goToPage(currentPage - 1)"
                aria-label="Go to previous page">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
          </svg>
          Previous
        </button>
        <span class="page-numbers">
          <button *ngFor="let page of getPageNumbers()"
                  type="button"
                  class="page-btn"
                  [class.active]="page === currentPage"
                  (click)="goToPage(page)"
                  [attr.aria-label]="'Go to page ' + page"
                  [attr.aria-current]="page === currentPage ? 'page' : null">
            {{ page }}
          </button>
        </span>
        <button type="button"
                class="btn btn-ghost btn-sm"
                [disabled]="currentPage === totalPages"
                (click)="goToPage(currentPage + 1)"
                aria-label="Go to next page">
          Next
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
          </svg>
        </button>
      </div>
    </nav>
  </section>

  <!-- Delete Confirmation Modal -->
  <app-confirm-modal
    [isVisible]="showDeleteModal"
    [title]="'Delete Purchase Order'"
    [message]="'Are you sure you want to delete the purchase order from ' + deletePurchaseOrderName + '? This action cannot be undone.'"
    [confirmText]="'Delete'"
    [type]="'warning'"
    (confirm)="confirmDelete()"
    (cancel)="cancelDelete()">
  </app-confirm-modal>
</main>
