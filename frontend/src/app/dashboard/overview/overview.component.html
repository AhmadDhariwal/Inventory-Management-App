<div class="dashboard-container">
  <header class="dashboard-header animate-fade-in">
    <div class="header-content">
      <h1 class="dashboard-title">
        <i class="fas fa-meteor"></i>
        System Dynamics
      </h1>
      <p class="dashboard-subtitle">Monitor real-time inventory flow and operational performance with precision.</p>
      
      <div class="header-stats">
        <div class="quick-stat">
          <span class="stat-label">System Integrity</span>
          <span class="stat-number">
            <i class="fas fa-check-circle" style="color: var(--status-success)"></i>
            Optimized
          </span>
        </div>
        <div class="quick-stat">
          <span class="stat-label">Inventory Health</span>
          <span class="stat-number">
            {{ (1 - (stats.lowStockItems / (stats.totalproducts || 1))) * 100 | number:'1.0-0' }}%
          </span>
        </div>
        <div class="quick-stat">
          <span class="stat-label">Flow Velocity</span>
          <span class="stat-number">{{ stats.pendingPurchases | number }} Active</span>
        </div>
        <div class="quick-access">
          <a class="activity-logs-btn" routerLink="/dashboard/activity-logs">
            <i class="fas fa-stream"></i>
            <span>Activity Stream</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <div *ngIf="loading" class="dashboard-content animate-fade-in">
    <section class="kpi-section">
      <div class="kpi-grid">
        <div class="kpi-card" *ngFor="let i of [1,2,3,4,5]">
           <div class="kpi-icon"><app-skeleton type="circle" width="40px" height="40px"></app-skeleton></div>
           <div class="kpi-content">
             <app-skeleton type="line" width="60%" height="0.8rem"></app-skeleton>
             <app-skeleton type="rect" width="80%" height="2rem" style="margin: 0.5rem 0"></app-skeleton>
             <app-skeleton type="line" width="40%" height="0.6rem"></app-skeleton>
           </div>
        </div>
      </div>
    </section>
    
    <div class="charts-container">
      <section class="charts-section" *ngFor="let i of [1,2,3]">
        <app-skeleton type="rect" width="100%" height="300px"></app-skeleton>
      </section>
    </div>
  </div>

  <div *ngIf="error" class="error-state">
    <i class="fas fa-exclamation-circle"></i>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadDashboard()">
      <i class="fas fa-sync"></i>
      Retry
    </button>
  </div>

  <div *ngIf="!loading && !error" class="dashboard-content animate-fade-in">
    <!-- Refined KPI Section -->
    <section class="kpi-section">
      <h2 class="section-title">Core Performance Metrics</h2>
      <div class="kpi-grid">
        <div class="kpi-card kpi-primary" tabindex="0">
          <div class="kpi-icon"><i class="fas fa-cube"></i></div>
          <div class="kpi-content">
            <h3>Unified Catalog</h3>
            <p class="kpi-value">{{ stats.totalproducts | number }}</p>
            <span class="kpi-label">Registered SKUs in system</span>
            <div class="kpi-trend up">
              <i class="fas fa-caret-up"></i>
              <span>+5.2% Growth</span>
            </div>
          </div>
        </div>

        <div class="kpi-card kpi-success" tabindex="0">
          <div class="kpi-icon"><i class="fas fa-handshake"></i></div>
          <div class="kpi-content">
            <h3>Verified Partners</h3>
            <p class="kpi-value">{{ stats.totalsuppliers | number }}</p>
            <span class="kpi-label">Active trade network</span>
            <div class="kpi-trend up">
              <i class="fas fa-caret-up"></i>
              <span>+2.1% Active</span>
            </div>
          </div>
        </div>

        <div class="kpi-card kpi-info" tabindex="0">
          <div class="kpi-icon"><i class="fas fa-boxes"></i></div>
          <div class="kpi-content">
            <h3>Aggregate Volume</h3>
            <p class="kpi-value">{{ stats.totalStock | number }}</p>
            <span class="kpi-label">Units available for dispatch</span>
            <div class="kpi-trend down">
              <i class="fas fa-caret-down"></i>
              <span>-1.3% Velocity</span>
            </div>
          </div>
        </div>

        <div class="kpi-card kpi-warning" tabindex="0">
          <div class="kpi-icon"><i class="fas fa-wallet"></i></div>
          <div class="kpi-content">
            <h3>Procurement Cycle</h3>
            <p class="kpi-value">{{ stats.totalpurchases | appCurrency }}</p>
            <span class="kpi-label">Total monthly spend</span>
            <div class="kpi-trend up">
              <i class="fas fa-caret-up"></i>
              <span>+12.8% Velocity</span>
            </div>
          </div>
        </div>

        <div class="kpi-card kpi-danger" [class.kpi-alert]="stats.lowStockItems > 0" tabindex="0">
          <div class="kpi-icon"><i class="fas fa-shield-alt"></i></div>
          <div class="kpi-content">
            <h3>Security Stock</h3>
            <p class="kpi-value">{{ stats.lowStockItems | number }}</p>
            <span class="kpi-label">Items at critical threshold</span>
            <div class="kpi-trend" *ngIf="stats.lowStockItems > 0">
              <span style="color: var(--status-error); font-weight: 700">Action Required</span>
            </div>
            <div class="kpi-trend up" *ngIf="stats.lowStockItems === 0">
              <span style="color: var(--status-success)">Optimized</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Operational Momentum -->
    <section class="activity-section">
      <h2 class="section-title">Operational Momentum</h2>
      <div class="activity-grid">
        <div class="activity-card activity-positive">
          <div class="activity-header">
            <div class="activity-icon"><i class="fas fa-arrow-up"></i></div>
            <h3>Inbound Volume</h3>
          </div>
          <div class="activity-content">
            <p class="activity-value">+ {{ stats.stockInToday | number }} Units</p>
          </div>
        </div>

        <div class="activity-card activity-negative">
          <div class="activity-header">
            <div class="activity-icon"><i class="fas fa-arrow-down"></i></div>
            <h3>Outbound Volume</h3>
          </div>
          <div class="activity-content">
            <p class="activity-value">- {{ stats.stockOutToday | number }} Units</p>
          </div>
        </div>

        <div class="activity-card">
          <div class="activity-header">
            <div class="activity-icon"><i class="fas fa-check-double"></i></div>
            <h3>Order Performance</h3>
          </div>
          <div class="activity-content">
            <p class="activity-value">{{ stats.approvedpurchases | number }} Approved</p>
          </div>
        </div>

        <div class="activity-card">
          <div class="activity-header">
            <div class="activity-icon"><i class="fas fa-clock"></i></div>
            <h3>Backlog Queue</h3>
          </div>
          <div class="activity-content">
            <p class="activity-value">{{ stats.pendingPurchases | number }} Pending</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Data Visuals -->
    <div class="charts-container">
      <section class="charts-section">
        <h2 class="section-title">Inventory Fluctuations</h2>
        <div class="single-chart">
          <app-stock-trend [trend]="stockTrendData"></app-stock-trend>
        </div>
      </section>

      <section class="charts-section">
        <h2 class="section-title">Procurement Foresight</h2>
        <div class="single-chart">
          <app-purchase-trend [trend]="purchaseTrendData"></app-purchase-trend>
        </div>
      </section>

      <section class="charts-section">
        <h2 class="section-title">Operational Throughput</h2>
        <div class="single-chart">
          <app-sales-trend [trend]="salesTrendData"></app-sales-trend>
        </div>
      </section>
    </div>

    <!-- AI Forecasting Widget -->
    <section class="widget-section">
      <app-stock-depletion-widget></app-stock-depletion-widget>
    </section>

    <!-- Health Widget -->
    <section class="widget-section">
      <app-low-stock-widget
        [lowStockItems]="lowStockItems"
        [totalCount]="stats.lowStockItems"
        (itemClick)="navigateToProduct($event)">
      </app-low-stock-widget>
    </section>

    <!-- Global Integrity Alert -->
    <section class="alerts-section" *ngIf="lowStockItems.length > 5">
      <div class="alerts-footer">
        <p>
          <i class="fas fa-info-circle"></i>
          <strong>Integrity Alert:</strong> System detected <strong>{{ lowStockItems.length }}</strong> products below safety threshold. Restocking recommended.
        </p>
        <button class="view-all-btn" (click)="router.navigate(['/stock/levels'])">
          Resolve Now
          <i class="fas fa-chevron-right" style="margin-left: 0.5rem"></i>
        </button>
      </div>
    </section>
  </div>
</div>
