# Two-Factor Authentication (2FA) Implementation Guide

This document provides a comprehensive overview of the 2FA implementation in the Inventory Management App, covering both backend and frontend components.

## Overview
The 2FA system adds an extra layer of security by requiring a Time-based One-Time Password (TOTP) from an authenticator app (like Google Authenticator or Authy) during login.

## 1. Backend Implementation

### Dependencies
- **`otplib` (v13.2.1)**: A widely used library for generating and verifying TOTP codes.
- **`jsonwebtoken`**: Already used for JWT session management.

### Key Components

#### User Model Modification ([src/models/user.js](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/backend/src/models/user.js))
We added new fields to store the 2FA state:
- `twoFactorEnabled`: Boolean to track if 2FA is active.
- `twoFactorSecret`: String to store the unique TOTP secret key for the user.

#### User Service ([src/services/user.service.js](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/backend/src/services/user.service.js))
This is where the core logic resides:
- **[toggleTwoFactor](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/frontend/src/app/shared/services/user.service.ts#153-167)**: Initiates the setup process. It generates a secret and a QR code URL (`keyuri`) but does *not* enable 2FA immediately. This prevents lockouts from accidental activation.
- **[verify2FA](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/backend/src/services/user.service.js#303-396) (Activation)**: The first verification during setup. If the code is correct, `twoFactorEnabled` is set to `true`. We use an `epochTolerance: 2` to allow for a +/- 60-second time drift between the user's phone and the server.
- **[handleuserlogin](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/backend/src/services/user.service.js#201-302) (Phase 1)**: Verifies the username and password. If 2FA is enabled, it returns a `requires2FA: true` flag and the `userId` instead of a JWT.
- **[verify2FA](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/backend/src/services/user.service.js#303-396) (Login Phase 2)**: Called after a successful Phase 1 login. It verifies the TOTP code and, if successful, issues the final JWT.

### Security Features
- **Phased Activation**: Users must prove they can generate a valid code before 2FA is actually enabled on their account.
- **Time Drift Tolerance**: The server is pre-configured to handle slight time mismatches (up to 60 seconds) that commonly occur with mobile device clocks.
- **Debug Logging**: During development, valid OTP codes are logged to the server console to prevent developers from getting locked out.

---

## 2. Frontend Implementation

### Key Components

#### Auth Service ([src/app/shared/services/auth.service.ts](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/frontend/src/app/shared/services/auth.service.ts))
- Added [verify2FA(userId, code)](file:///c:/Users/ahmad.hassan/Desktop/Inventory-Management-App/backend/src/services/user.service.js#303-396) method to call the backend verification endpoint.
- Updated login responses to handle the `requires2FA` flag.

#### Login Component (`src/app/auth/login/`)
- Modified the login flow to be two-step.
- If the backend returns `requires2FA`, the password form is hidden, and an OTP input field is displayed.

#### Account Settings (`src/app/settings/account-settings/`)
- **Setup UI**: A premium, high-fidelity interface for enabling 2FA.
- **QR Code Display**: Uses `api.qrserver.com` to generate a scanable QR code from the `otpauthUrl` provided by the backend.
- **Manual Input**: Displays the secret key for users who prefer manual setup.
- **Verification Step**: Requires the user to enter their first code to "Activate" the feature.

### Dependencies
- **`ngModel` (FormsModule)**: Used for the 2FA code input binding.
- **`FontAwesome`**: Used for brand-specific icons (Shield, QR Code, etc.).

---

## 3. How to Use
1. Go to **Account Settings** -> **Security & Privacy**.
2. Click **Enable 2FA**.
3. Scan the QR code with your Authenticator app.
4. Enter the 6-digit code shown in your app and click **Verify & Activate**.
5. Log out and try logging back in. After your password, you will be prompted for the code.
